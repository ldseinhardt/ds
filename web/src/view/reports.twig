{% extends "layout.twig" %}

{% block title %}
  {{ parent() }} :: Relatórios
{% endblock %}

{% block content %}

  <div class="col-sm-12 text-center">
    <div class="panel panel-default">
      <div class="panel-body">
        <h3>Relatórios</h3>
        <hr width="75%">
        <div class="panel panel-primary">
          <div class="panel-heading">
            <h3 class="panel-title">Filtrar dados</h3>
          </div>
          <div class="panel-body">
            <div class="row text-center">
              <div class="col-sm-5 col-sm-offset-1">
                <div class="form-group">
                  <h3>Data Inicial</h3>
                  <input type="hidden" class="form-control" id="date_initial" name="date_initial" placeholder="Período Inicial">
                  <div id="date-initial" class="datetimepicker"></div>
                </div>
              </div>
              <div class="col-sm-5">
                <div class="form-group">
                  <h3>Data Final</h3>
                  <input type="hidden" class="form-control" id="date_final" name="date_final" placeholder="Período Inicial">
                  <div id="date-final" class="datetimepicker"></div>
                </div>
              </div>
            </div>
            <div class="row text-left">
              <div class="col-sm-5 col-sm-offset-1">
                <div class="form-group">
                  <select id="category" name="category_id" class="form-control">
                    <option value="">Categoria</option>
                    {% for category in categories %}
                      <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="col-sm-5">
                <div class="form-group">
                  <div class="radio">
                    <label>
                      <input type="radio" name="type_id" value="" checked> Todas
                    </label>
                    <label>
                      <input type="radio" name="type_id" value="1"> Despesas
                    </label>
                    <label>
                      <input type="radio" name="type_id" value="2"> Receitas
                    </label>
                  </div>
                </div>
              </div>
            </div>
            <div class="row text-left">
              <div class="col-sm-5 col-sm-offset-1">
                <div class="form-group">
                  <input type="text" class="form-control" id="location" name="location" placeholder="Localização" minlength="10" maxlength="128">
                </div>
              </div>
              <div class="col-sm-5">
                <div class="form-group">
                  <input type="number" class="form-control" id="birthyear" name="birthyear" placeholder="Ano de nascimento" min="1901" max="2016">
                </div>
              </div>
            </div>
            <div class="row text-left">
              <div class="col-sm-5 col-sm-offset-1">
                <div class="form-group">
                  <input type="text" class="form-control" id="occupation" name="occupation" placeholder="Ocupação" maxlength="64">
                </div>
              </div>
              <div class="col-sm-5">
                <div class="form-group">
                  <select id="education" name="education_id" class="form-control">
                    <option value="">Escolaridade</option>
                    <option value="1">Ensino fundamental incompleto</option>
                    <option value="2">Ensino fundamental completo</option>
                    <option value="3">Ensino médio incompleto</option>
                    <option value="4">Ensino médio completo</option>
                    <option value="5">Ensino superior completo</option>
                    <option value="6">Curso de pós-graduação completo</option>
                    <option value="7">Estudante de ensino fundamental ou ensino médio</option>
                    <option value="8">Estudante de graduação ou pós-graduação</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="row text-left">
              <div class="col-sm-10 col-sm-offset-1">
                <div class="form-group text-left">
                  <button class="btn btn-raised btn-primary" id="filter">Filtrar</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="panel panel-primary" id="calendar">
          <div class="panel-heading">
            <h3 class="panel-title">Calendar Chart</h3>
          </div>
          <div class="panel-body">
            <div class="graph"></div>
          </div>
        </div>

        <div class="panel panel-primary" id="line">
          <div class="panel-heading">
            <h3 class="panel-title">Line Chart</h3>
          </div>
          <div class="panel-body">
            <div class="graph"></div>
          </div>
        </div>

        <div class="panel panel-primary" id="bar">
          <div class="panel-heading">
            <h3 class="panel-title">Bar chart</h3>
          </div>
          <div class="panel-body">
            <div class="graph"></div>
          </div>
        </div>

        <div class="panel panel-primary" id="bar2">
          <div class="panel-heading">
            <h3 class="panel-title">Bar chart</h3>
          </div>
          <div class="panel-body">
            <div class="graph"></div>
          </div>
        </div>

        <div class="panel panel-primary" id="expense-vs-income">
          <div class="panel-heading">
            <h3 class="panel-title">Despesas vs Receitas</h3>
          </div>
          <div class="panel-body">
            <div class="graph"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

{% endblock %}

{% block style %}
  <link rel="stylesheet" href="{{ path('file', {type: 'vendor', file: 'eonasdan-bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.min.css'}) }}">
  <style>
    .datepicker .active {
      background-color: #009688 !important;
    }

    .datepicker .day:not(.active)::before {
        border-bottom-color: #009688 !important;
    }

    .datepicker .day:not(.active):not(.disabled):hover,
    .datepicker .month:not(.active):not(.disabled):hover,
    .datepicker .year:not(.active):not(.disabled):hover,
    .datepicker .next:hover,
    .datepicker .picker-switch:hover,
    .datepicker .prev:hover {
      color: #111 !important;
    }
  </style>
{% endblock %}

{% block script %}
  <script src="{{ path('file', {type: 'vendor', file: 'moment/min/moment-with-locales.min.js'}) }}"></script>
  <script src="{{ path('file', {type: 'vendor', file: 'eonasdan-bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js'}) }}"></script>
  <script>
    $(function() {
      google.charts.load('current', {'packages':['corechart', 'bar', 'line', 'calendar']});
      google.charts.setOnLoadCallback(drawCharts);

      //https://developers.google.com/chart
      function drawCharts() {
        var dataTable = new google.visualization.DataTable();
        dataTable.addColumn({ type: 'date', id: 'Date' });
        dataTable.addColumn({ type: 'number', id: 'Won/Loss' });
        dataTable.addRows([
           [ new Date(2013, 9, 4), 38177 ],
           [ new Date(2013, 9, 5), 38705 ],
           [ new Date(2013, 9, 12), 38210 ],
           [ new Date(2013, 9, 13), 38029 ],
           [ new Date(2013, 9, 19), 38823 ],
           [ new Date(2013, 9, 23), 38345 ],
           [ new Date(2013, 9, 24), 38436 ],
           [ new Date(2013, 9, 30), 38447 ]
         ]);

        var chart = new google.visualization.Calendar($('#calendar .graph')[0]);

        var options = {
          title: "Red Sox Attendance"
        };

        chart.draw(dataTable, options);

        var data = new google.visualization.DataTable();
        data.addColumn('number', 'X');
        data.addColumn('number', 'Dogs');
        data.addColumn('number', 'Cats');

        data.addRows([
          [0, 0, 0],    [1, 10, 5],   [2, 23, 15],  [3, 17, 9],   [4, 18, 10],  [5, 9, 5],
          [6, 11, 3],   [7, 27, 19],  [8, 33, 25],  [9, 40, 32],  [10, 32, 24], [11, 35, 27],
          [12, 30, 22], [13, 40, 32], [14, 42, 34], [15, 47, 39], [16, 44, 36], [17, 48, 40],
          [18, 52, 44], [19, 54, 46], [20, 42, 34], [21, 55, 47], [22, 56, 48], [23, 57, 49],
          [24, 60, 52], [25, 50, 42], [26, 52, 44], [27, 51, 43], [28, 49, 41], [29, 53, 45],
          [30, 55, 47], [31, 60, 52], [32, 61, 53], [33, 59, 51], [34, 62, 54], [35, 65, 57],
          [36, 62, 54], [37, 58, 50], [38, 55, 47], [39, 61, 53], [40, 64, 56], [41, 65, 57],
          [42, 63, 55], [43, 66, 58], [44, 67, 59], [45, 69, 61], [46, 69, 61], [47, 70, 62],
          [48, 72, 64], [49, 68, 60], [50, 66, 58], [51, 65, 57], [52, 67, 59], [53, 70, 62],
          [54, 71, 63], [55, 72, 64], [56, 73, 65], [57, 75, 67], [58, 70, 62], [59, 68, 60],
          [60, 64, 56], [61, 60, 52], [62, 65, 57], [63, 67, 59], [64, 68, 60], [65, 69, 61],
          [66, 70, 62], [67, 72, 64], [68, 75, 67], [69, 80, 72]
        ]);

        var options = {
          hAxis: {
            title: 'Time'
          },
          vAxis: {
            title: 'Popularity'
          },
          series: {
            1: {curveType: 'function'}
          }
        };

        var chart = new google.visualization.LineChart($('#line .graph')[0]);
        chart.draw(data, options);

        var data = new google.visualization.DataTable();
        data.addColumn('timeofday', 'Time of Day');
        data.addColumn('number', 'Motivation Level');
        data.addColumn('number', 'Energy Level');

        data.addRows([
          [{v: [8, 0, 0], f: '8 am'}, 1, .25],
          [{v: [9, 0, 0], f: '9 am'}, 2, .5],
          [{v: [10, 0, 0], f:'10 am'}, 3, 1],
          [{v: [11, 0, 0], f: '11 am'}, 4, 2.25],
          [{v: [12, 0, 0], f: '12 pm'}, 5, 2.25],
          [{v: [13, 0, 0], f: '1 pm'}, 6, 3],
          [{v: [14, 0, 0], f: '2 pm'}, 7, 4],
          [{v: [15, 0, 0], f: '3 pm'}, 8, 5.25],
          [{v: [16, 0, 0], f: '4 pm'}, 9, 7.5],
          [{v: [17, 0, 0], f: '5 pm'}, 10, 10],
        ]);

        var options = {
          title: 'Motivation and Energy Level Throughout the Day',
          hAxis: {
            title: 'Time of Day',
            format: 'h:mm a',
            viewWindow: {
              min: [7, 30, 0],
              max: [17, 30, 0]
            }
          },
          vAxis: {
            title: 'Rating (scale of 1-10)'
          }
        };

        var chart = new google.charts.Bar($('#bar .graph')[0]);
        chart.draw(data, options);

        var data = google.visualization.arrayToDataTable([
          ['City', '2010 Population', '2000 Population'],
          ['New York City, NY', 8175000, 8008000],
          ['Los Angeles, CA', 3792000, 3694000],
          ['Chicago, IL', 2695000, 2896000],
          ['Houston, TX', 2099000, 1953000],
          ['Philadelphia, PA', 1526000, 1517000]
        ]);

        var options = {
          chart: {
            title: 'Population of Largest U.S. Cities',
            subtitle: 'Based on most recent and previous census data'
          },
          hAxis: {
            title: 'Total Population',
            minValue: 0,
          },
          vAxis: {
            title: 'City'
          },
          bars: 'horizontal'
        };

        var chart = new google.charts.Bar($('#bar2 .graph')[0]);
        chart.draw(data, options);

        $.post('/reports/types.json', {
          'date_initial': $('[name=date_initial]').val(),
          'date_final': $('[name=date_final]').val(),
          /* Não usar estes filtros neste relatório
            'category_id': $('[name=category_id]').val(),
            'type_id': $('[name=type_id]:checked').val(),
          */
          'location': $('[name=location]').val(),
          'birthyear': $('[name=birthyear]').val(),
          'occupation': $('[name=occupation]').val(),
          'education_id': $('[name=education_id]').val()
        }, function(data_report) {
          var container = $('#expense-vs-income .graph');
          if (data_report && data_report.length) {
            var data = new google.visualization.DataTable();
            data.addColumn('string', 'id');
            data.addColumn('number', 'Total');
            data.addRows(data_report);
            container.html('');
            var chart = new google.visualization.PieChart(container[0]);
            chart.draw(data);
          } else {
            container.html('<p align="center">Não há dados.</p>');
          }
        })
      }

      $('#location').autocomplete({
        serviceUrl: '/autocomplete/location/'
      });

      $('#occupation').autocomplete({
        serviceUrl: '/autocomplete/occupation/'
      });

      $('#education, #category').change(function() {
        if ($(':selected', this).val() === '') {
          $(this).css('color', '#bdbdbd');
        } else {
          $(this).css('color', '#555');
        }
        $('option', this).css('color', '#555');
      });

      $('#education, #category').trigger('change');

      var datetimepickers = $('.datetimepicker');

      datetimepickers.datetimepicker({
        inline: true,
        locale: 'pt-BR',
        format: 'L'
      });

      $(datetimepickers[0]).on('dp.change', function(evt) {
        $('#date_initial')
          .val(new Date(evt.date._d.valueOf()).toISOString().split(/T/)[0]);
      });
      $(datetimepickers[1]).on('dp.change', function(evt) {
        $('#date_final')
          .val(new Date(evt.date._d.valueOf()).toISOString().split(/T/)[0]);
      });

      $('#filter').click(function() {
        drawCharts();
      });
    });
  </script>
{% endblock %}
