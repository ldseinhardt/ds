{% extends "layout.twig" %}

{% block title %}
  {{ parent() }} :: Relatórios
{% endblock %}

{% block content %}

  <div class="col-sm-12 text-center">
    <div class="panel panel-default">
      <div class="panel-body">
        <h3>Relatórios</h3>
        <hr width="75%">
        <div class="panel panel-primary">
          <div class="panel-heading">
            <h3 class="panel-title">Filtrar dados</h3>
          </div>
          <div class="panel-body">
            <div class="row text-center">
              <div class="col-sm-5 col-sm-offset-1">
                <div class="form-group">
                  <h3>Data Inicial</h3>
                  <input type="hidden" class="form-control" id="date_initial" name="date_initial" placeholder="Período Inicial">
                  <div id="date-initial" class="datetimepicker"></div>
                </div>
              </div>
              <div class="col-sm-5">
                <div class="form-group">
                  <h3>Data Final</h3>
                  <input type="hidden" class="form-control" id="date_final" name="date_final" placeholder="Período Inicial">
                  <div id="date-final" class="datetimepicker"></div>
                </div>
              </div>
            </div>
            <div class="row text-left">
              <div class="col-sm-5 col-sm-offset-1">
                <div class="form-group">
                  <select id="category" name="category_id" class="form-control">
                    <option value="">Categoria</option>
                    {% for category in categories %}
                      <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="col-sm-5">
                <div class="form-group">
                  <div class="radio">
                    <label>
                      <input type="radio" name="type_id" value="" checked> Todas
                    </label>
                    <label>
                      <input type="radio" name="type_id" value="1"> Despesas
                    </label>
                    <label>
                      <input type="radio" name="type_id" value="2"> Receitas
                    </label>
                  </div>
                </div>
              </div>
            </div>
            <div class="row text-left">
              <div class="col-sm-5 col-sm-offset-1">
                <div class="form-group">
                  <input type="text" class="form-control" id="location" name="location" placeholder="Localização" minlength="10" maxlength="128">
                </div>
              </div>
              <div class="col-sm-5">
                <div class="form-group">
                  <input type="number" class="form-control" id="birthyear" name="birthyear" placeholder="Ano de nascimento" min="1901" max="2016">
                </div>
              </div>
            </div>
            <div class="row text-left">
              <div class="col-sm-5 col-sm-offset-1">
                <div class="form-group">
                  <input type="text" class="form-control" id="occupation" name="occupation" placeholder="Profissão" maxlength="64">
                </div>
              </div>
              <div class="col-sm-5">
                <div class="form-group">
                  <select id="education" name="education_id" class="form-control">
                    <option value="">Escolaridade</option>
                    <option value="1">Ensino fundamental incompleto</option>
                    <option value="2">Ensino fundamental completo</option>
                    <option value="3">Ensino médio incompleto</option>
                    <option value="4">Ensino médio completo</option>
                    <option value="5">Ensino superior completo</option>
                    <option value="6">Curso de pós-graduação completo</option>
                    <option value="7">Estudante de ensino fundamental ou ensino médio</option>
                    <option value="8">Estudante de graduação ou pós-graduação</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="row text-left">
              <div class="col-sm-10 col-sm-offset-1">
                <div class="form-group text-left">
                  <button class="btn btn-raised btn-primary" id="filter">Filtrar</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="panel panel-primary" id="bar">
          <div class="panel-heading">
            <h3 class="panel-title">Despesas/Receitas por mês</h3>
          </div>
          <div class="panel-body">
            <div class="graph"></div>
          </div>
        </div>

        <div class="panel panel-primary" id="transactions-per-day">
          <div class="panel-heading">
            <h3 class="panel-title">Transações ao longo dos dias</h3>
          </div>
          <div class="panel-body">
            <div class="graph"></div>
          </div>
        </div>

        <div class="panel panel-primary" id="expenses-by-category">
          <div class="panel-heading">
            <h3 class="panel-title">Despesas por categoria</h3>
          </div>
          <div class="panel-body">
            <div class="graph"></div>
          </div>
        </div>

        <div class="panel panel-primary" id="incomes-by-category">
          <div class="panel-heading">
            <h3 class="panel-title">Receitas por categoria</h3>
          </div>
          <div class="panel-body">
            <div class="graph"></div>
          </div>
        </div>

        <div class="panel panel-primary" id="expense-vs-income">
          <div class="panel-heading">
            <h3 class="panel-title">Despesas vs Receitas</h3>
          </div>
          <div class="panel-body">
            <div class="graph"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

{% endblock %}

{% block style %}
  <link rel="stylesheet" href="{{ path('file', {type: 'vendor', file: 'eonasdan-bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.min.css'}) }}">
  <style>
    .datepicker .active {
      background-color: #009688 !important;
    }

    .datepicker .day:not(.active)::before {
        border-bottom-color: #009688 !important;
    }

    .datepicker .day:not(.active):not(.disabled):hover,
    .datepicker .month:not(.active):not(.disabled):hover,
    .datepicker .year:not(.active):not(.disabled):hover,
    .datepicker .next:hover,
    .datepicker .picker-switch:hover,
    .datepicker .prev:hover {
      color: #111 !important;
    }
  </style>
{% endblock %}

{% block script %}
  <script src="{{ path('file', {type: 'vendor', file: 'moment/min/moment-with-locales.min.js'}) }}"></script>
  <script src="{{ path('file', {type: 'vendor', file: 'eonasdan-bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js'}) }}"></script>
  <script>
    $(function() {
      google.charts.load('current', {'packages':['corechart', 'bar', 'line'], 'language': 'pt-BR'});
      google.charts.setOnLoadCallback(drawCharts);

      //https://developers.google.com/chart
      function drawCharts() {

/********************************************************
 Gráfico Despesas/Receitas por mês
*********************************************************/

        var data = new google.visualization.DataTable();
        
        data.addColumn('timeofday', 'Time of Day');
        data.addColumn('number', 'Motivation Level');
        data.addColumn('number', 'Energy Level');

        data.addRows([
          [{v: [8, 0, 0], f: '8 am'}, 1, .25],
          [{v: [9, 0, 0], f: '9 am'}, 2, .5],
          [{v: [10, 0, 0], f:'10 am'}, 3, 1],
          [{v: [11, 0, 0], f: '11 am'}, 4, 2.25],
          [{v: [12, 0, 0], f: '12 pm'}, 5, 2.25],
          [{v: [13, 0, 0], f: '1 pm'}, 6, 3],
          [{v: [14, 0, 0], f: '2 pm'}, 7, 4],
          [{v: [15, 0, 0], f: '3 pm'}, 8, 5.25],
          [{v: [16, 0, 0], f: '4 pm'}, 9, 7.5],
          [{v: [17, 0, 0], f: '5 pm'}, 10, 10],
        ]);

        var options = {
          title: 'Motivation and Energy Level Throughout the Day',
          hAxis: {
            title: 'Time of Day',
            format: 'h:mm a',
            viewWindow: {
              min: [7, 30, 0],
              max: [17, 30, 0]
            }
          },
          vAxis: {
            title: 'Rating (scale of 1-10)'
          }
        };

        var chart = new google.charts.Bar($('#bar .graph')[0]);
        chart.draw(data, options);

/********************************************************
 Gráfico Transações por dia
*********************************************************/

        $.post('/reports/transactions-per-day.json', {
          'date_initial': $('[name=date_initial]').val(),
          'date_final': $('[name=date_final]').val(),
          /* Não usar estes filtros neste relatório
            'category_id': $('[name=category_id]').val(),
            'type_id': $('[name=type_id]:checked').val(),
          */
          'location': $('[name=location]').val(),
          'birthyear': $('[name=birthyear]').val(),
          'occupation': $('[name=occupation]').val(),
          'education_id': $('[name=education_id]').val()
        }, function(data_report) {

          var container = $('#transactions-per-day .graph');
          if (data_report && data_report.length) {
            var data = new google.visualization.DataTable();
            data.addColumn('date', 'id');
            data.addColumn('number', 'Despesas');
            data.addColumn('number', 'Receitas');
            data.addRows(data_report.map(function(e) {
              return [new Date(e[0].replace(/\-/g, ', ')), e[1], e[2]];
            }));
            container.html('');

            var chart = new google.visualization.LineChart(container[0]);
            chart.draw(data, {
              height: 300,
              hAxis: {
                title: 'dias'
              },
              vAxis: {
                title: 'transações em reais'
              },
              colors: ['#F44336', '#4CAF50']
            });
          } else {
            container.html('<p align="center">Não há dados.</p>');
          }
        });

/********************************************************
 Gráfico Despesas por categoria
*********************************************************/

        $.post('/reports/expenses-by-category.json', {
          'date_initial': $('[name=date_initial]').val(),
          'date_final': $('[name=date_final]').val(),
          /* Não usar estes filtros neste relatório
            'category_id': $('[name=category_id]').val(),
            'type_id': $('[name=type_id]:checked').val(),
          */
          'location': $('[name=location]').val(),
          'birthyear': $('[name=birthyear]').val(),
          'occupation': $('[name=occupation]').val(),
          'education_id': $('[name=education_id]').val()
        }, function(data_report) {

          var container = $('#expenses-by-category .graph');

          if (data_report && data_report.length) {

            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Categoria');
            data.addColumn('number', 'Valor');
            data.addRows(data_report);
            container.html('');

            var chart = new google.charts.Bar($('#expenses-by-category .graph')[0]);
            //var chart = new google.visualization.LineChart(container[0]);
            chart.draw(data, {
              bars: 'horizontal',
              height: 500,
              colors: '#F44336'
            });
          } else {
            container.html('<p align="center">Não há dados.</p>');
          }
        });

/********************************************************
 Gráfico Receitas por categoria
*********************************************************/

        $.post('/reports/incomes-by-category.json', {
          'date_initial': $('[name=date_initial]').val(),
          'date_final': $('[name=date_final]').val(),
          /* Não usar estes filtros neste relatório
            'category_id': $('[name=category_id]').val(),
            'type_id': $('[name=type_id]:checked').val(),
          */
          'location': $('[name=location]').val(),
          'birthyear': $('[name=birthyear]').val(),
          'occupation': $('[name=occupation]').val(),
          'education_id': $('[name=education_id]').val()
        }, function(data_report) {

          var container = $('#incomes-by-category .graph');

          if (data_report && data_report.length) {

            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Categoria');
            data.addColumn('number', 'Valor');
            data.addRows(data_report);
            container.html('');

            var chart = new google.charts.Bar($('#incomes-by-category .graph')[0]);
            //var chart = new google.visualization.LineChart(container[0]);
            chart.draw(data, {
              bars: 'horizontal',
              height: 150,
              colors: '#4CAF50'
            });
          } else {
            container.html('<p align="center">Não há dados.</p>');
          }
        });

/********************************************************
 Gráfico Despesas x Receitas
*********************************************************/

        $.post('/reports/expense-vs-income.json', {
          'date_initial': $('[name=date_initial]').val(),
          'date_final': $('[name=date_final]').val(),
          /* Não usar estes filtros neste relatório
            'category_id': $('[name=category_id]').val(),
            'type_id': $('[name=type_id]:checked').val(),
          */
          'location': $('[name=location]').val(),
          'birthyear': $('[name=birthyear]').val(),
          'occupation': $('[name=occupation]').val(),
          'education_id': $('[name=education_id]').val()
        }, function(data_report) {

          var container = $('#expense-vs-income .graph');
          if (data_report && data_report.length) {
            var data = new google.visualization.DataTable();
            data.addColumn('string', 'id');
            data.addColumn('number', 'Total');
            data.addRows(data_report);
            container.html('');

            var chart = new google.visualization.PieChart(container[0]);
            chart.draw(data, {
              height: 300,
              colors: ['#F44336', '#4CAF50']
            });
          } else {
            container.html('<p align="center">Não há dados.</p>');
          }
        });
      }

/********************************************************/

      $('#location').autocomplete({
        serviceUrl: '/autocomplete/location/'
      });

      $('#occupation').autocomplete({
        serviceUrl: '/autocomplete/occupation/'
      });

      $('#education, #category').change(function() {
        if ($(':selected', this).val() === '') {
          $(this).css('color', '#bdbdbd');
        } else {
          $(this).css('color', '#555');
        }
        $('option', this).css('color', '#555');
      });

      $('#education, #category').trigger('change');

      var datetimepickers = $('.datetimepicker');

      datetimepickers.datetimepicker({
        inline: true,
        locale: 'pt-BR',
        format: 'L'
      });

      $(datetimepickers[0]).on('dp.change', function(evt) {
        $('#date_initial')
          .val(new Date(evt.date._d.valueOf()).toISOString().split(/T/)[0]);
      });
      $(datetimepickers[1]).on('dp.change', function(evt) {
        $('#date_final')
          .val(new Date(evt.date._d.valueOf()).toISOString().split(/T/)[0]);
      });

      $('#filter').click(function() {
        drawCharts();
      });
    });
  </script>
{% endblock %}
